<h2 mat-dialog-title>{{ data.route ? 'Editar Ruta' : 'Agregar Ruta' }}</h2>
<mat-dialog-content>
    <form [formGroup]="form" class="connection-form">
        <div class="row">
            <div class="col-12 mt-2">
                <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Caja Inicio</mat-label>
                    <mat-select formControlName="startBoxId">
                        <mat-option class="search-option">
                             <div style="position: relative; width: 100%;">
                                 <input [formControl]="startBoxFilterCtrl" placeholder="Buscar caja..." 
                                        class="pro-search-input"
                                        (click)="$event.stopPropagation()" 
                                        (keydown)="$event.stopPropagation()">
                                 <span class="search-icon">üîç</span>
                             </div>
                        </mat-option>
                        <mat-option *ngFor="let box of filteredStartBoxes | async" [value]="box.id">
                            {{ box.name }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            
            <div class="col-12">
                <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Caja Fin</mat-label>
                    <mat-select formControlName="endBoxId">
                        <mat-option class="search-option">
                             <div style="position: relative; width: 100%;">
                                 <input [formControl]="endBoxFilterCtrl" placeholder="Buscar caja..." 
                                        class="pro-search-input"
                                        (click)="$event.stopPropagation()" 
                                        (keydown)="$event.stopPropagation()">
                                 <span class="search-icon">üîç</span>
                             </div>
                        </mat-option>
                        <mat-option *ngFor="let box of filteredEndBoxes | async" [value]="box.id">
                            {{ box.name }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>

            <div class="col-12">
                <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Notas / Observaci√≥n</mat-label>
                    <textarea matInput formControlName="notes" rows="2"></textarea>
                </mat-form-field>
            </div>

            <div class="col-12">
                <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Tipo de Ruta</mat-label>
                    <mat-select formControlName="type">
                        <mat-option value="principal">Principal</mat-option>
                        <mat-option value="derivada">Derivada</mat-option>
                    </mat-select>
                </mat-form-field>
            </div>

            <div class="col-12">
                <label class="mb-2 d-block">Color de la Ruta:</label>
                
                <div class="color-grid py-2">
                    <!-- Predefined Colors -->
                    <div *ngFor="let c of predefinedColors"
                         class="color-swatch"
                         [style.background]="c"
                         [class.selected]="form.get('color')?.value === c"
                         (click)="form.get('color')?.setValue(c)"
                         [title]="c">
                    </div>

                    <!-- Custom Color Trigger -->
                    <div class="color-swatch custom-color-btn" 
                         [class.selected]="!predefinedColors.includes(form.get('color')?.value)"
                         (click)="colorInput.click()"
                         title="Otro color..."
                         [style.background]="!predefinedColors.includes(form.get('color')?.value) ? form.get('color')?.value : '#fff'">
                        <span *ngIf="predefinedColors.includes(form.get('color')?.value)" style="font-size: 20px; font-weight: bold; color: #555;">+</span>
                    </div>
                </div>

                <!-- Hidden native input for custom colors -->
                <input #colorInput type="color" formControlName="color" class="hidden-input">
            </div>

            <!-- Photo Upload Section -->
            <div class="col-12" *ngIf="routeId">
                <div class="photo-upload-section">
                    <label class="mb-2 d-block"><strong>Fotos del Trabajo</strong></label>
                    
                    <input type="file" 
                           #fileInput 
                           (change)="onFileSelected($event)" 
                           accept="image/*" 
                           multiple 
                           style="display: none;">
                    
                    <button mat-raised-button 
                            color="accent" 
                            type="button"
                            class="photo-upload-btn mb-2"
                            (click)="fileInput.click()">
                        <mat-icon>add_photo_alternate</mat-icon>
                        Seleccionar Fotos
                    </button>

                    <div *ngIf="selectedFiles.length > 0" class="mb-2">
                        <p class="mb-1"><small>{{ selectedFiles.length }} foto(s) seleccionada(s)</small></p>
                        <button mat-flat-button 
                                color="primary" 
                                type="button"
                                (click)="uploadSelectedPhotos()">
                            <mat-icon>cloud_upload</mat-icon>
                            Subir Fotos
                        </button>
                    </div>

                    <!-- Photo Grid -->
                    <div class="photo-grid" *ngIf="photos.length > 0">
                        <div *ngFor="let photo of photos" 
                             class="photo-thumbnail"
                             (click)="viewPhoto(photo)">
                            <img [src]="getPhotoUrl(photo)" [alt]="'Photo ' + photo.id">
                            <button mat-icon-button 
                                    class="photo-delete-btn"
                                    color="warn"
                                    (click)="deletePhoto(photo, $event)"
                                    type="button">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</mat-dialog-content>
<mat-dialog-actions align="end">
    <button mat-button (click)="onCancel()">Cancelar</button>
    <button mat-flat-button color="primary" (click)="onSave()" [disabled]="form.invalid">Guardar</button>
</mat-dialog-actions>
