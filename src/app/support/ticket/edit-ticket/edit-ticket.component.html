<form ngNativeValidate [formGroup]="formTicket" (ngSubmit)="enviarDatos()" >
  <div class="container my-4">
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <button type="button" mat-icon-button (click)="goTickets()">
            <mat-icon>arrow_back_ios</mat-icon>
          </button>
          Editar Ticket</mat-card-title
        >
        <mat-card-subtitle style="margin-left: 55px">
          Ticket: {{ dataTicket?.code }}
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="row">
          <div class="col-12">
            <mat-form-field appearance="fill" class="w-100">
              <mat-label>Proyecto</mat-label>
              <mat-select formControlName="destination_id" required>
                <mat-option
                  *ngFor="let destination of destinations"
                  [value]="destination.id"
                >
                  {{ destination.name }}
                </mat-option>
              </mat-select>
              <mat-error
                *ngIf="formTicket.get('destination_id')?.hasError('required')"
              >
                Destino es requerido
              </mat-error>
            </mat-form-field>
          </div>
        </div>
        <div class="row">
          <div class="col col-md-6">
            <mat-form-field class="control-full-width" appearance="fill">
              <mat-label>CategorÃ­a</mat-label>
              <mat-select formControlName="category_ticket_id">
                @for (category of categoryTickets; track category) {
                <mat-option [value]="category.id">{{
                  category.name
                }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
          <div class="col col-md-6">
            <mat-form-field>
              <mat-label>Prioridad</mat-label>
              <mat-select formControlName="priority">
                <mat-option value="baja">Baja</mat-option>
                <mat-option value="normal">Normal</mat-option>
                <mat-option value="alta">Alta</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>

        <div class="row">
          <div class="col-12 col-md-12">
            <div class="mb-2">
              <mat-form-field class="control-full-width my-form-field">
                <mat-label>CLiente</mat-label>
                <mat-icon matSuffix>search</mat-icon>
                <input
                  type="text"
                  matInput
                  formControlName="customer_id"
                  [matAutocomplete]="auto"
                  value="{{ dataTicket?.customer?.customerName }}"
                />
                <mat-autocomplete
                  #auto="matAutocomplete"
                  [displayWith]="displayFn"
                >
                  <mat-option
                    *ngFor="let option of filteredCustomer | async"
                    [value]="option"
                  >
                    {{ option.customerName }}
                  </mat-option>
                </mat-autocomplete>
                <!-- {{customerIdValue}} -->
              </mat-form-field>
            </div>

            <div class="mb-2">
              <mat-form-field appearance="fill">
                <mat-label>Asunto:</mat-label>
                <input
                  matInput
                  placeholder="Asunto"
                  formControlName="subject"
                />
              </mat-form-field>
            </div>

            <div class="mb-2">
              <mat-form-field>
                <mat-label>Nota</mat-label>
                <textarea
                  matInput
                  cdkTextareaAutosize
                  #autosize="cdkTextareaAutosize"
                  cdkAutosizeMinRows="3"
                  cdkAutosizeMaxRows="5"
                  formControlName="description"
                ></textarea>
              </mat-form-field>
            </div>
            <!-- Adjuntos -->
            <div class="row">
              <div class="col col-md-12">
                <div class="mb-3">
                  <input type="file" (change)="onFileSelected($event)" />
                </div>
                <div class="mb-3">
                  <div class="attachment-grid" style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <div *ngFor="let attach of dataTicket?.attachments" style="text-align: center;">
                      <!-- Si es imagen, mostrar miniatura -->
                      <div *ngIf="isImage(attach.file_path)" style="position: relative; display: inline-block;">
                        <img 
                          [src]="getAttachmentUrl(attach.id)" 
                          [alt]="attach.file_path"
                          style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd; cursor: pointer;"
                          (click)="viewAttachment(attach.id)"
                          (error)="onImageError($event)"
                        />
                        <button 
                        type="button"
                          mat-mini-fab 
                          color="warn"
                          (click)="deleteAttachment(attach.id, $event)"
                          style="position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; min-height: 24px;"
                          title="Eliminar adjunto"
                        >
                          <mat-icon style="font-size: 16px; line-height: 24px;">delete</mat-icon>
                        </button>
                        <div style="font-size: 12px; margin-top: 5px; word-break: break-word; max-width: 100px;">
                          {{ attach.file_path.replace("attachments/", "") }}
                        </div>
                      </div>
                      <!-- Si es archivo, mostrar link de descarga -->
                      <div *ngIf="!isImage(attach.file_path)" style="position: relative; display: inline-flex; align-items: center; gap: 5px;">
                        <a 
                          [href]="getAttachmentUrl(attach.id)"
                          [download]="attach.file_path.replace('attachments/', '')"
                          style="color: #007bff; text-decoration: underline;"
                        >
                          ðŸ“„ {{ attach.file_path.replace("attachments/", "") }}
                        </a>
                        <button 
                          mat-icon-button 
                          color="warn"
                          (click)="deleteAttachment(attach.id, $event)"
                          style="width: 24px; height: 24px;"
                          title="Eliminar adjunto"
                        >
                          <mat-icon style="font-size: 18px;">delete</mat-icon>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Contratos -->
      </mat-card-content>
    </mat-card>

    <!-- Botones -->
    <div class="row-buttons">
      <button
        [disabled]="formTicket.invalid"
        type="submit"
        color="primary"
        mat-flat-button
        style="margin-right: 5px"
      >
        Guardar
      </button>
      <button
        type="button"
        (click)="goTickets()"
        color="accent"
        mat-raised-button
      >
        Cancelar
      </button>
    </div>
  </div>
</form>
